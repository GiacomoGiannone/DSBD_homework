<!DOCTYPE html>
<html lang="it">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>User Manager Test</title>
	<style>
		body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; color: #111; }
		h1 { margin-top: 0; }
		.card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
		.row { display: flex; gap: 12px; flex-wrap: wrap; }
		label { font-size: 12px; color: #374151; display: block; margin-bottom: 6px; }
		input { padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; min-width: 260px; }
		button { padding: 8px 12px; border: 0; border-radius: 6px; background: #2563eb; color: #fff; cursor: pointer; }
		button:disabled { opacity: 0.6; cursor: not-allowed; }
		.out { white-space: pre-wrap; background: #f9fafb; border: 1px dashed #e5e7eb; padding: 10px; border-radius: 6px; min-height: 40px; }
		.ok { color: #065f46; }
		.warn { color: #92400e; }
		.err { color: #991b1b; }
	</style>
	<script>
		async function api(path, payload, outEl) {
			outEl.textContent = '...';
			try {
				const res = await fetch(path, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload)
				});
				const text = await res.text();
				let body;
				try { body = JSON.parse(text); } catch { body = { raw: text }; }
				outEl.textContent = `HTTP ${res.status}\n` + JSON.stringify(body, null, 2);
				outEl.className = 'out ' + (res.status >= 200 && res.status < 300 ? 'ok' : res.status === 400 || res.status === 409 ? 'warn' : 'err');
			} catch (e) {
				outEl.textContent = 'Network error: ' + e;
				outEl.className = 'out err';
			}
		}

		function getVal(id) { return document.getElementById(id).value.trim(); }

		function wire() {
			// Il server genera automaticamente request_id basato su email, username, operation e timestamp.

			// Add User (email + username + password obbligatori)
			const addBtn = document.getElementById('btn-add');
			addBtn.addEventListener('click', () => {
				const email = getVal('add-email');
				const username = getVal('add-username');
				const password = document.getElementById('add-password').value; // allow spaces
				const out = document.getElementById('out-add');
				if (!email || !username || !password) {
					out.textContent = 'Compila email, username e password';
					out.className = 'out warn';
					return;
				}
				api('/add', { operation: 'AddUser', email, username, password }, out);
			});

			// Login (email O username) + password
			const loginBtn = document.getElementById('btn-login');
			loginBtn.addEventListener('click', () => {
				const identity = getVal('login-identity');
				const password = document.getElementById('login-password').value;
				const out = document.getElementById('out-login');
				if (!identity || !password) {
					out.textContent = 'Inserisci email o username e la password';
					out.className = 'out warn';
					return;
				}
					fetch('/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ identity, password }) })
					.then(async res => {
						const text = await res.text();
						let body; try { body = JSON.parse(text); } catch { body = { raw: text }; }
						out.textContent = `HTTP ${res.status}\n` + JSON.stringify(body, null, 2);
						out.className = 'out ' + (res.status >= 200 && res.status < 300 ? 'ok' : res.status === 400 || res.status === 409 ? 'warn' : 'err');
						if (res.status === 200) {
								// Preferisci email risolta dal backend; fallback su identity se già un'email
								const resolved = body.email || (identity.includes('@') ? identity : '');
								if (resolved) {
									window.location.href = `http://localhost:8082/data_test?email=${encodeURIComponent(resolved)}`;
								} else {
									out.textContent += "\nLogin ok, ma non sono riuscito a determinare l'email.";
								}
						}
					})
					.catch(e => {
						out.textContent = 'Network error: ' + e;
						out.className = 'out err';
					});
			});

			// Delete (email O username) + password
			const delBtn = document.getElementById('btn-del');
			delBtn.addEventListener('click', () => {
				const identity = getVal('del-identity');
				const password = document.getElementById('del-password').value;
				const out = document.getElementById('out-del');
				if (!identity || !password) {
					out.textContent = 'Compila email o username e password';
					out.className = 'out warn';
					return;
				}
				api('/delete', { operation: 'DeleteUser', identity, password }, out);
			});
		}

		window.addEventListener('DOMContentLoaded', wire);
	</script>
	<!-- Questa pagina funziona se servita dallo stesso server Flask (http://localhost:8081/). -->
	<!-- Se apri come file:// potresti incorrere in CORS. Usa la route / per servirla. -->
	</head>
<body>
	<h1>User Manager Tester</h1>
	<p>Assicurati che il servizio sia in esecuzione su <code>http://localhost:8081</code>.</p>

		<div class="card">
		<h2>1) Create User</h2>
		<div class="row">
			<div>
				<label for="add-email">Email</label>
				<input id="add-email" type="email" placeholder="alice@example.com" />
			</div>
			<div>
				<label for="add-username">Username</label>
				<input id="add-username" type="text" placeholder="alice" />
			</div>
			<div>
				<label for="add-password">Password</label>
				<input id="add-password" type="password" placeholder="••••••••" />
			</div>
			<div style="align-self: end">
				<button id="btn-add">Add User</button>
			</div>
		</div>
		<div id="out-add" class="out"></div>
	</div>

	<div class="card">
		<h2>2) Login</h2>
		<div class="row">
			<div>
				<label for="login-identity">Email o Username</label>
				<input id="login-identity" type="text" placeholder="alice@example.com oppure alice" />
			</div>
			<div>
				<label for="login-password">Password</label>
				<input id="login-password" type="password" placeholder="••••••••" />
			</div>
			<div style="align-self: end">
				<button id="btn-login">Login</button>
			</div>
		</div>
		<div id="out-login" class="out"></div>
	</div>

		<div class="card">
		<h2>3) Delete</h2>
		<div class="row">
			<div>
				<label for="del-identity">Email o Username</label>
				<input id="del-identity" type="text" placeholder="alice@example.com oppure alice" />
			</div>
			<div>
				<label for="del-password">Password</label>
				<input id="del-password" type="password" placeholder="••••••••" />
			</div>
			<div style="align-self: end">
				<button id="btn-del">Delete User</button>
			</div>
		</div>
		<div id="out-del" class="out"></div>
	</div>

</body>
</html>
