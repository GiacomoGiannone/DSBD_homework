version: "3.9"

services:
  # -------------------------------------------------------
  # USER DATABASE (isolated on user_db_net)
  # -------------------------------------------------------
  userdb:
    image: mysql:8.0
    container_name: userdb
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: userdb
    # Rimuovi la mappatura porta esterna se non serve accesso diretto da host
    # ports:
    #   - "3307:3306"
    volumes:
      - userdb_data:/var/lib/mysql
      - ./DB/user_db_init.sql:/docker-entrypoint-initdb.d/user_db_init.sql
    networks:
      - user_db_net

  # -------------------------------------------------------
  # DATA DATABASE (isolated on data_db_net)
  # -------------------------------------------------------
  datadb:
    image: mysql:8.0
    container_name: datadb
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: datadb
    # ports:
    #   - "3308:3306"
    volumes:
      - datadb_data:/var/lib/mysql
      - ./DB/data_db_collector_init.sql:/docker-entrypoint-initdb.d/data_db_collector_init.sql
    networks:
      - data_db_net

  # -------------------------------------------------------
  # USER MANAGER MICROSERVICE (app_net + user_db_net)
  # -------------------------------------------------------
  user-manager:
    build: ./UserManager
    container_name: user-manager
    environment:
      DB_HOST: userdb
      DB_PORT: 3306
      DB_NAME: userdb
      DB_USER: root
      DB_PASSWORD: root
    ports:
      - "50051:50051"   # gRPC
      - "8081:8081"     # REST test (Postman)
    depends_on:
      - userdb
    networks:
      - app_net
      - user_db_net

  # -------------------------------------------------------
  # DATA COLLECTOR MICROSERVICE (app_net + data_db_net)
  # -------------------------------------------------------
  data-collector:
    build: ./DataCollector
    container_name: data-collector
    environment:
      USER_MANAGER_HOST: user-manager
      USER_MANAGER_PORT: 50051

      DB_HOST: datadb
      DB_PORT: 3306
      DB_NAME: datadb
      DB_USER: root
      DB_PASSWORD: root

      # OpenSky OAuth credentials (read from DataCollector/credentials.json)
      # OPENSKY_USER: "your_username"
      # OPENSKY_PASS: "your_password"
    volumes:
      - ./DataCollector/credentials.json:/credentials/credentials.json:ro
    ports:
      - "8082:8082"     # REST test (Postman)
    depends_on:
      - datadb
      - user-manager
    networks:
      - app_net
      - data_db_net

# -------------------------------------------------------
# VOLUMI PERSISTENTI
# -------------------------------------------------------
volumes:
  userdb_data:
  datadb_data:

# -------------------------------------------------------
# RETE INTERNA
# -------------------------------------------------------
networks:
  app_net:
    driver: bridge
  user_db_net:
    driver: bridge
    internal: true  # impedisce accesso diretto dall'host agli IP interni
  data_db_net:
    driver: bridge
    internal: true